import Button01 from "@/components/etc/Button01";
import axios from "axios";
import Link from "next/link";
import { notFound, redirect } from "next/navigation";
import ImgSelectButton from "../imgSelectButton";
import Polybutton from "../polybutton";
import { Metadata } from "next";
import ResultRender from "../resultRender";

export const metadata: Metadata = {
  title: "추론결과페이지",
  description: "Generated by create next app",
};

// 서버에서 폴링을 수행하는 함수
async function GetResult(
  jobid: string,
  retries = 5,
  interval = 4000
): Promise<ApiResponseDTO<ImageProcessResultDTO> | null> {
  const springurl = process.env.SPRING_API;
  await new Promise((res) => setTimeout(res, 2000));

  for (let i = 0; i < retries; i++) {
    try {
      console.log(`🔁 폴링 시도 ${i + 1}`);
      const res = await axios.get<ApiResponseDTO<ImageProcessResultDTO>>(
        `${springurl}/api/inference/${jobid}/result`
      );
      if (res.data.status === "done") {
        console.log();
        console.log("✅ 결과 도착", res.data);
        return res.data;
      }
    } catch (err) {
      // console.error("폴링 실패", err);
    }
    await new Promise((res) => setTimeout(res, interval));
  }
  return null;
}

export default async function Page({ params }: { params: { jobid: string } }) {
  const { jobid } = await params;
  const result = await GetResult(jobid);

  if (!result) {
    // notFound();
    redirect("/?error=server_err");
  }

  return (
    <div className="flex flex-col justify-center items-center gap-6 px-4 py-8 max-w-6xl mx-auto text-white">
      <div className="text-center space-y-2">
        <h1 className="text-2xl md:text-3xl font-bold tracking-tight text-cyan-300">
          {result.message}
        </h1>
        <p className="text-base md:text-lg text-slate-300">
          화면에서 품목을 선택해주세요
        </p>
      </div>

      <ResultRender apiRespone={result} jobid={jobid} />
    </div>
  );
}