import Button01 from "@/components/etc/Button01";
import axios from "axios";
import Link from "next/link";
import { notFound, redirect } from "next/navigation";
import ImgSelectButton from "../imgSelectButton";
import Polybutton from "../polybutton";
import { Metadata } from "next";
import ResultRender from "../resultRender";


export const metadata: Metadata = {
    title: "ì¶”ë¡ ê²°ê³¼í˜ì´ì§€",
    description: "Generated by create next app",
};

// ì„œë²„ì—ì„œ í´ë§ì„ ìˆ˜í–‰í•˜ëŠ” í•¨ìˆ˜
async function GetResult(jobid: string, retries = 5, interval = 4000): Promise<ApiResponseDTO<ImageProcessResultDTO> | null> {
    const springurl = process.env.SPRING_API;
    await new Promise(res => setTimeout(res, 2000));
    
    for (let i = 0; i < retries; i++) {
        try {
            console.log(`ğŸ” í´ë§ ì‹œë„ ${i + 1}`);
            const res = await axios.get<ApiResponseDTO<ImageProcessResultDTO>>(`${springurl}/api/inference/${jobid}/result`);
            if (res.data.status === 'done') {
                console.log()
                console.log('âœ… ê²°ê³¼ ë„ì°©',res.data);
                return res.data;
            }
        } catch (err) {
            // console.error("í´ë§ ì‹¤íŒ¨", err);
        }
        await new Promise(res => setTimeout(res, interval));
    }
    return null;
}

export default async function Page({ params }: { params: { jobid: string } }) {
    const {jobid} = await params; 
    const result = await GetResult(jobid);
    
    if (!result) {
    // notFound();
        redirect('/?error=server_err')
    }
    
    return (
        <div className="flex flex-col justify-center items-center gap-1.5 p-2">
            
            <div className="flex flex-col justify-center items-center">
                <h1>{result.message}</h1>
                <p>í™”ë©´ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”</p>
            </div>
            <ResultRender apiRespone={result} jobid={jobid} /> 
        </div>
    );
}
